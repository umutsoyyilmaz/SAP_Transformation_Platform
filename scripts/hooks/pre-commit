#!/usr/bin/env bash
# ──────────────────────────────────────────────────────────────────────────────
# pre-commit hook — SAP Transformation Platform
#
# Checks:
#   1. Warn if > 15 changed files (override: git commit --no-verify)
#   2. Warn if > 500 total changed lines
#   3. Run pytest — fail = commit blocked
#
# Install: cp scripts/hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# ──────────────────────────────────────────────────────────────────────────────

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${GREEN}[pre-commit]${NC} Running checks..."

# ── 1. File count check ─────────────────────────────────────────────────────
FILE_COUNT=$(git diff --cached --name-only | wc -l | tr -d ' ')
if [ "$FILE_COUNT" -gt 15 ]; then
    echo -e "${YELLOW}⚠ WARNING: $FILE_COUNT files staged (threshold: 15)${NC}"
    echo "   Consider splitting into smaller commits."
    echo "   Override with: git commit --no-verify"
    echo ""
    # Warning only — don't block
fi

# ── 2. Line count check ─────────────────────────────────────────────────────
LINES_ADDED=$(git diff --cached --stat | tail -1 | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo 0)
LINES_DELETED=$(git diff --cached --stat | tail -1 | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+' || echo 0)
TOTAL_LINES=$((LINES_ADDED + LINES_DELETED))

if [ "$TOTAL_LINES" -gt 500 ]; then
    echo -e "${YELLOW}⚠ WARNING: $TOTAL_LINES lines changed (threshold: 500)${NC}"
    echo "   (+$LINES_ADDED / -$LINES_DELETED)"
    echo "   Consider splitting into smaller commits."
    echo ""
fi

# ── 3. Run pytest ────────────────────────────────────────────────────────────
echo -e "${GREEN}[pre-commit]${NC} Running tests..."
if command -v .venv/bin/python &> /dev/null; then
    PYTHON=".venv/bin/python"
elif command -v python3 &> /dev/null; then
    PYTHON="python3"
else
    PYTHON="python"
fi

if ! $PYTHON -m pytest tests/ -q --tb=no 2>&1 | tail -5; then
    echo -e "${RED}✗ Tests failed — commit blocked.${NC}"
    echo "   Fix failing tests or use: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}✓ All pre-commit checks passed.${NC}"
