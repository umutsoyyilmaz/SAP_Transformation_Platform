"""New hierarchy v1

Revision ID: 25890e807851
Revises: 
Create Date: 2026-02-09 13:54:47.101687

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '25890e807851'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('ai_audit_logs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('action', sa.String(length=50), nullable=False, comment='llm_call, embedding_create, suggestion_create, search, ...'),
    sa.Column('provider', sa.String(length=30), nullable=True),
    sa.Column('model', sa.String(length=80), nullable=True),
    sa.Column('user', sa.String(length=150), nullable=True),
    sa.Column('program_id', sa.Integer(), nullable=True),
    sa.Column('prompt_hash', sa.String(length=64), nullable=True, comment='SHA-256 of prompt for dedup'),
    sa.Column('prompt_summary', sa.String(length=500), nullable=True, comment='First 500 chars of prompt'),
    sa.Column('tokens_used', sa.Integer(), nullable=True),
    sa.Column('cost_usd', sa.Float(), nullable=True),
    sa.Column('latency_ms', sa.Integer(), nullable=True),
    sa.Column('response_summary', sa.String(length=500), nullable=True, comment='First 500 chars of response'),
    sa.Column('success', sa.Boolean(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('metadata_json', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('programs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('project_type', sa.String(length=50), nullable=True, comment='greenfield | brownfield | bluefield | selective_data_transition'),
    sa.Column('methodology', sa.String(length=50), nullable=True, comment='sap_activate | agile | waterfall | hybrid'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='planning | active | on_hold | completed | cancelled'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='low | medium | high | critical'),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('go_live_date', sa.Date(), nullable=True),
    sa.Column('sap_product', sa.String(length=50), nullable=True, comment='S/4HANA | SuccessFactors | Ariba | BTP | Other'),
    sa.Column('deployment_option', sa.String(length=30), nullable=True, comment='on_premise | cloud | hybrid'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('ai_embeddings',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('entity_type', sa.String(length=50), nullable=False, comment='requirement, backlog_item, risk, config_item, ...'),
    sa.Column('entity_id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=True),
    sa.Column('chunk_text', sa.Text(), nullable=False),
    sa.Column('chunk_index', sa.Integer(), nullable=True, comment='Chunk position within entity'),
    sa.Column('embedding_json', sa.Text(), nullable=True, comment='JSON-encoded float[] for SQLite; vector(1536) in PG'),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, MM, SD...'),
    sa.Column('phase', sa.String(length=50), nullable=True),
    sa.Column('metadata_json', sa.Text(), nullable=True, comment='Extra metadata as JSON'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('ai_embeddings', schema=None) as batch_op:
        batch_op.create_index('ix_ai_embedding_entity', ['entity_type', 'entity_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_ai_embeddings_entity_type'), ['entity_type'], unique=False)

    op.create_table('ai_suggestions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('suggestion_type', sa.String(length=50), nullable=False, comment='fit_gap_classification, defect_triage, ...'),
    sa.Column('entity_type', sa.String(length=50), nullable=False, comment='requirement, defect, risk, ...'),
    sa.Column('entity_id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=True),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('suggestion_data', sa.Text(), nullable=True, comment='JSON: proposed field changes'),
    sa.Column('current_data', sa.Text(), nullable=True, comment='JSON: snapshot of current values'),
    sa.Column('confidence', sa.Float(), nullable=True, comment='0.0 – 1.0 confidence score'),
    sa.Column('model_used', sa.String(length=80), nullable=True),
    sa.Column('prompt_version', sa.String(length=20), nullable=True),
    sa.Column('reasoning', sa.Text(), nullable=True, comment="AI's reasoning / explanation"),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('reviewed_by', sa.String(length=150), nullable=True),
    sa.Column('review_note', sa.Text(), nullable=True),
    sa.Column('applied_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('reviewed_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('ai_suggestions', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_ai_suggestions_status'), ['status'], unique=False)

    op.create_table('ai_usage_logs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('provider', sa.String(length=30), nullable=False, comment='anthropic / openai / local'),
    sa.Column('model', sa.String(length=80), nullable=False),
    sa.Column('prompt_tokens', sa.Integer(), nullable=True),
    sa.Column('completion_tokens', sa.Integer(), nullable=True),
    sa.Column('total_tokens', sa.Integer(), nullable=True),
    sa.Column('cost_usd', sa.Float(), nullable=True),
    sa.Column('latency_ms', sa.Integer(), nullable=True, comment='End-to-end latency in milliseconds'),
    sa.Column('user', sa.String(length=150), nullable=True),
    sa.Column('purpose', sa.String(length=100), nullable=True, comment='e.g. requirement_analyst, defect_triage'),
    sa.Column('program_id', sa.Integer(), nullable=True),
    sa.Column('success', sa.Boolean(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('committees',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('committee_type', sa.String(length=50), nullable=True, comment='steering | advisory | review | working_group'),
    sa.Column('meeting_frequency', sa.String(length=30), nullable=True, comment='daily | weekly | biweekly | monthly | ad_hoc'),
    sa.Column('chair_name', sa.String(length=100), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('notifications',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=True),
    sa.Column('recipient', sa.String(length=150), nullable=True, comment="User name or 'all' for broadcast"),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('message', sa.Text(), nullable=True),
    sa.Column('category', sa.String(length=30), nullable=True),
    sa.Column('severity', sa.String(length=20), nullable=True),
    sa.Column('entity_type', sa.String(length=30), nullable=True, comment='risk/action/issue/decision/...'),
    sa.Column('entity_id', sa.Integer(), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=True),
    sa.Column('read_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('phases',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('order', sa.Integer(), nullable=True, comment='Sort order within program'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='not_started | in_progress | completed | skipped'),
    sa.Column('planned_start', sa.Date(), nullable=True),
    sa.Column('planned_end', sa.Date(), nullable=True),
    sa.Column('actual_start', sa.Date(), nullable=True),
    sa.Column('actual_end', sa.Date(), nullable=True),
    sa.Column('completion_pct', sa.Integer(), nullable=True, comment='0-100'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('scenarios',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('sap_module', sa.String(length=50), nullable=True, comment='Primary SAP module: FI, CO, MM, SD, PP, HCM, Basis, etc.'),
    sa.Column('process_area', sa.String(length=50), nullable=True, comment='E2E process: order_to_cash, procure_to_pay, record_to_report, etc.'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | in_analysis | analyzed | approved | on_hold'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='critical | high | medium | low'),
    sa.Column('owner', sa.String(length=200), nullable=True, comment='Responsible person / team for this scenario'),
    sa.Column('workstream', sa.String(length=200), nullable=True, comment='Associated workstream name'),
    sa.Column('total_workshops', sa.Integer(), nullable=True),
    sa.Column('total_requirements', sa.Integer(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('sprints',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False, comment='e.g. Sprint 1, Iteration 2.3'),
    sa.Column('goal', sa.Text(), nullable=True, comment='Sprint goal / objective'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='planning | active | completed | cancelled'),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('capacity_points', sa.Integer(), nullable=True, comment='Planned capacity in story points'),
    sa.Column('velocity', sa.Integer(), nullable=True, comment='Actual velocity (completed points) — set at sprint close'),
    sa.Column('order', sa.Integer(), nullable=True, comment='Sort order within program'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('test_plans',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False, comment='e.g. SIT Master Plan, UAT Plan v2'),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | active | completed | cancelled'),
    sa.Column('test_strategy', sa.Text(), nullable=True, comment='High-level test approach / strategy notes'),
    sa.Column('entry_criteria', sa.Text(), nullable=True, comment='Conditions to start this plan'),
    sa.Column('exit_criteria', sa.Text(), nullable=True, comment='Conditions to close this plan'),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('workstreams',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('ws_type', sa.String(length=30), nullable=True, comment='functional | technical | cross_cutting'),
    sa.Column('lead_name', sa.String(length=100), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='active | on_hold | completed'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('actions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=30), nullable=False, comment='Auto-generated: ACT-001'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True),
    sa.Column('owner', sa.String(length=150), nullable=True),
    sa.Column('priority', sa.String(length=20), nullable=True),
    sa.Column('action_type', sa.String(length=30), nullable=True),
    sa.Column('due_date', sa.Date(), nullable=True),
    sa.Column('completed_date', sa.Date(), nullable=True),
    sa.Column('linked_entity_type', sa.String(length=30), nullable=True, comment='risk/issue/requirement/...'),
    sa.Column('linked_entity_id', sa.Integer(), nullable=True),
    sa.Column('workstream_id', sa.Integer(), nullable=True),
    sa.Column('phase_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['phase_id'], ['phases.id'], ),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workstream_id'], ['workstreams.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code')
    )
    op.create_table('decisions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=30), nullable=False, comment='Auto-generated: DEC-001'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True),
    sa.Column('owner', sa.String(length=150), nullable=True),
    sa.Column('priority', sa.String(length=20), nullable=True),
    sa.Column('decision_date', sa.Date(), nullable=True),
    sa.Column('decision_owner', sa.String(length=150), nullable=True, comment='Final approver / decision maker'),
    sa.Column('alternatives', sa.Text(), nullable=True, comment='JSON or freetext list of alternatives'),
    sa.Column('rationale', sa.Text(), nullable=True),
    sa.Column('impact_description', sa.Text(), nullable=True),
    sa.Column('reversible', sa.Boolean(), nullable=True),
    sa.Column('workstream_id', sa.Integer(), nullable=True),
    sa.Column('phase_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['phase_id'], ['phases.id'], ),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workstream_id'], ['workstreams.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code')
    )
    op.create_table('gates',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('phase_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('gate_type', sa.String(length=30), nullable=True, comment='quality_gate | milestone | decision_point'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='pending | passed | failed | waived'),
    sa.Column('planned_date', sa.Date(), nullable=True),
    sa.Column('actual_date', sa.Date(), nullable=True),
    sa.Column('criteria', sa.Text(), nullable=True, comment='Acceptance criteria / checklist'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['phase_id'], ['phases.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('issues',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=30), nullable=False, comment='Auto-generated: ISS-001'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True),
    sa.Column('owner', sa.String(length=150), nullable=True),
    sa.Column('priority', sa.String(length=20), nullable=True),
    sa.Column('severity', sa.String(length=20), nullable=True),
    sa.Column('escalation_path', sa.String(length=300), nullable=True),
    sa.Column('root_cause', sa.Text(), nullable=True),
    sa.Column('resolution', sa.Text(), nullable=True),
    sa.Column('resolution_date', sa.Date(), nullable=True),
    sa.Column('workstream_id', sa.Integer(), nullable=True),
    sa.Column('phase_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['phase_id'], ['phases.id'], ),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workstream_id'], ['workstreams.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code')
    )
    op.create_table('processes',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('scenario_id', sa.Integer(), nullable=False),
    sa.Column('parent_id', sa.Integer(), nullable=True, comment='L3 → parent L2.  L2 → NULL'),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('level', sa.String(length=5), nullable=True, comment='L2 (Business Process) | L3 (Process Step)'),
    sa.Column('process_id_code', sa.String(length=50), nullable=True, comment='SAP process ID, e.g. O2C, P2P, RTR'),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, CO, MM, SD, PP, etc.'),
    sa.Column('order', sa.Integer(), nullable=True),
    sa.Column('code', sa.String(length=50), nullable=True, comment='L3 short code, e.g. 1OC, 3XX, BD9'),
    sa.Column('scope_decision', sa.String(length=30), nullable=True, comment='in_scope | out_of_scope | deferred  (L3 only)'),
    sa.Column('fit_gap', sa.String(length=20), nullable=True, comment='fit | gap | partial_fit | standard  (L3 only)'),
    sa.Column('sap_tcode', sa.String(length=50), nullable=True, comment='SAP transaction code: VA01, ME21N, FB01  (L3 only)'),
    sa.Column('sap_reference', sa.String(length=100), nullable=True, comment='SAP Best Practice reference ID  (L3 only)'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='low | medium | high | critical  (L3 only)'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['parent_id'], ['processes.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['scenario_id'], ['scenarios.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('risks',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=30), nullable=False, comment='Auto-generated: RSK-001'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True),
    sa.Column('owner', sa.String(length=150), nullable=True),
    sa.Column('priority', sa.String(length=20), nullable=True),
    sa.Column('probability', sa.Integer(), nullable=True, comment='1-5 scale'),
    sa.Column('impact', sa.Integer(), nullable=True, comment='1-5 scale'),
    sa.Column('risk_score', sa.Integer(), nullable=True, comment='probability × impact'),
    sa.Column('rag_status', sa.String(length=10), nullable=True, comment='green/amber/orange/red'),
    sa.Column('risk_category', sa.String(length=30), nullable=True),
    sa.Column('risk_response', sa.String(length=20), nullable=True),
    sa.Column('mitigation_plan', sa.Text(), nullable=True),
    sa.Column('contingency_plan', sa.Text(), nullable=True),
    sa.Column('trigger_event', sa.String(length=300), nullable=True),
    sa.Column('workstream_id', sa.Integer(), nullable=True),
    sa.Column('phase_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['phase_id'], ['phases.id'], ),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workstream_id'], ['workstreams.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code')
    )
    op.create_table('team_members',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('email', sa.String(length=200), nullable=True),
    sa.Column('role', sa.String(length=50), nullable=True, comment='program_manager | project_lead | stream_lead | consultant | developer | team_member'),
    sa.Column('raci', sa.String(length=20), nullable=True, comment='responsible | accountable | consulted | informed'),
    sa.Column('workstream_id', sa.Integer(), nullable=True),
    sa.Column('organization', sa.String(length=100), nullable=True, comment='Company / partner name'),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workstream_id'], ['workstreams.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('test_cycles',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('plan_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False, comment='e.g. SIT Cycle 1'),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='planning | in_progress | completed | cancelled'),
    sa.Column('test_layer', sa.String(length=30), nullable=True, comment='unit | sit | uat | regression | performance | cutover_rehearsal'),
    sa.Column('start_date', sa.Date(), nullable=True),
    sa.Column('end_date', sa.Date(), nullable=True),
    sa.Column('order', sa.Integer(), nullable=True, comment='Sort order within plan'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['plan_id'], ['test_plans.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('workshops',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('scenario_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('session_type', sa.String(length=50), nullable=True, comment='fit_gap_workshop | requirement_gathering | process_mapping | review | design_workshop | demo | sign_off | training'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='planned | in_progress | completed | cancelled'),
    sa.Column('session_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('duration_minutes', sa.Integer(), nullable=True),
    sa.Column('location', sa.String(length=200), nullable=True),
    sa.Column('facilitator', sa.String(length=200), nullable=True),
    sa.Column('attendees', sa.Text(), nullable=True, comment='Comma-separated attendee names'),
    sa.Column('agenda', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('decisions', sa.Text(), nullable=True),
    sa.Column('action_items', sa.Text(), nullable=True),
    sa.Column('requirements_identified', sa.Integer(), nullable=True),
    sa.Column('fit_count', sa.Integer(), nullable=True),
    sa.Column('gap_count', sa.Integer(), nullable=True),
    sa.Column('partial_fit_count', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['scenario_id'], ['scenarios.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('analyses',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('process_id', sa.Integer(), nullable=False, comment='L3 process step being analyzed'),
    sa.Column('workshop_id', sa.Integer(), nullable=True, comment='Workshop session where this analysis was performed'),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('analysis_type', sa.String(length=30), nullable=True, comment='workshop | fit_gap | demo | prototype | review | workshop_note'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='planned | in_progress | completed | cancelled'),
    sa.Column('fit_gap_result', sa.String(length=20), nullable=True, comment='fit | partial_fit | gap'),
    sa.Column('decision', sa.Text(), nullable=True, comment='Workshop outcome / decision'),
    sa.Column('attendees', sa.Text(), nullable=True, comment='Comma-separated names'),
    sa.Column('date', sa.Date(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['process_id'], ['processes.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workshop_id'], ['workshops.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('requirements',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('process_id', sa.Integer(), nullable=True, comment='L2 Business Process this requirement belongs to'),
    sa.Column('workshop_id', sa.Integer(), nullable=True, comment='Workshop that produced this requirement'),
    sa.Column('req_parent_id', sa.Integer(), nullable=True, comment='Parent requirement for hierarchy'),
    sa.Column('code', sa.String(length=50), nullable=True, comment='Short requirement ID, e.g. REQ-FI-001'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('req_type', sa.String(length=50), nullable=True, comment='business | functional | technical | non_functional | integration'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='must_have | should_have | could_have | wont_have (MoSCoW)'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | discussed | analyzed | approved | in_progress | realized | verified | deferred | rejected'),
    sa.Column('source', sa.String(length=100), nullable=True, comment='Origin: workshop, stakeholder, regulation, gap_analysis, etc.'),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, CO, MM, SD, PP, HCM, Basis, etc.'),
    sa.Column('effort_estimate', sa.String(length=20), nullable=True, comment='xs | s | m | l | xl or story points'),
    sa.Column('acceptance_criteria', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['process_id'], ['processes.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['req_parent_id'], ['requirements.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['workshop_id'], ['workshops.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('backlog_items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('sprint_id', sa.Integer(), nullable=True),
    sa.Column('requirement_id', sa.Integer(), nullable=True, comment='Link to source requirement'),
    sa.Column('process_id', sa.Integer(), nullable=True, comment='L3 process step that generated this WRICEF (gap)'),
    sa.Column('code', sa.String(length=50), nullable=True, comment='Short ID, e.g. WRICEF-FI-001, ENH-SD-042'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('wricef_type', sa.String(length=20), nullable=False, comment='workflow | report | interface | conversion | enhancement | form'),
    sa.Column('sub_type', sa.String(length=50), nullable=True, comment="Further classification: e.g. 'BAdI', 'RFC', 'Adobe Form', 'ALV'"),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, CO, MM, SD, PP, HCM, Basis, BTP, etc.'),
    sa.Column('transaction_code', sa.String(length=30), nullable=True, comment='Related T-code: ME21N, VA01, FB01, etc.'),
    sa.Column('package', sa.String(length=50), nullable=True, comment='SAP development package / Z-namespace'),
    sa.Column('transport_request', sa.String(length=30), nullable=True, comment='SAP transport request number'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='new | design | build | test | deploy | closed | blocked | cancelled'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='low | medium | high | critical'),
    sa.Column('assigned_to', sa.String(length=100), nullable=True, comment='Developer / consultant name'),
    sa.Column('story_points', sa.Integer(), nullable=True, comment='Fibonacci: 1,2,3,5,8,13,21'),
    sa.Column('estimated_hours', sa.Float(), nullable=True, comment='Effort in person-hours'),
    sa.Column('actual_hours', sa.Float(), nullable=True, comment='Actual effort logged'),
    sa.Column('complexity', sa.String(length=20), nullable=True, comment='low | medium | high | very_high'),
    sa.Column('board_order', sa.Integer(), nullable=True, comment='Display order within the same status column on the kanban board'),
    sa.Column('acceptance_criteria', sa.Text(), nullable=True),
    sa.Column('technical_notes', sa.Text(), nullable=True, comment='Functional spec / tech notes'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['process_id'], ['processes.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['sprint_id'], ['sprints.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('config_items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('requirement_id', sa.Integer(), nullable=True, comment='Link to source requirement'),
    sa.Column('code', sa.String(length=50), nullable=True, comment='Short ID, e.g. CFG-FI-001, CFG-SD-042'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, CO, MM, SD, PP, etc.'),
    sa.Column('config_key', sa.String(length=100), nullable=True, comment='IMG path or config key, e.g. SPRO > FI > Tax > Define Tax Codes'),
    sa.Column('transaction_code', sa.String(length=30), nullable=True, comment='Customizing T-code: OB40, OVZG, etc.'),
    sa.Column('transport_request', sa.String(length=30), nullable=True, comment='SAP transport request number for config transport'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='new | design | build | test | deploy | closed | blocked | cancelled'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='low | medium | high | critical'),
    sa.Column('assigned_to', sa.String(length=100), nullable=True, comment='Functional consultant name'),
    sa.Column('complexity', sa.String(length=20), nullable=True, comment='low | medium | high'),
    sa.Column('estimated_hours', sa.Float(), nullable=True),
    sa.Column('actual_hours', sa.Float(), nullable=True),
    sa.Column('acceptance_criteria', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('open_items',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('requirement_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('item_type', sa.String(length=30), nullable=True, comment='question | decision | dependency | escalation'),
    sa.Column('owner', sa.String(length=200), nullable=True, comment='Person/team responsible for resolution'),
    sa.Column('due_date', sa.Date(), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='open | in_progress | resolved | closed'),
    sa.Column('resolution', sa.Text(), nullable=True, comment='What was the decision/answer (filled when resolved)'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='critical | high | medium | low'),
    sa.Column('blocker', sa.Boolean(), nullable=True, comment='If true, the linked requirement cannot progress until resolved'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('requirement_process_mappings',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('requirement_id', sa.Integer(), nullable=False),
    sa.Column('process_id', sa.Integer(), nullable=False, comment='L3 process step'),
    sa.Column('coverage_type', sa.String(length=20), nullable=True, comment='full | partial | none'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['process_id'], ['processes.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('requirement_traces',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('requirement_id', sa.Integer(), nullable=False),
    sa.Column('target_type', sa.String(length=50), nullable=False, comment='phase | workstream | scenario | requirement | gate'),
    sa.Column('target_id', sa.Integer(), nullable=False),
    sa.Column('trace_type', sa.String(length=50), nullable=True, comment='implements | depends_on | derived_from | tested_by | related_to'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('functional_specs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('backlog_item_id', sa.Integer(), nullable=True, comment='Link to WRICEF item (mutually exclusive with config_item_id)'),
    sa.Column('config_item_id', sa.Integer(), nullable=True, comment='Link to config item (mutually exclusive with backlog_item_id)'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('content', sa.Text(), nullable=True, comment='Full FS document body (Markdown/HTML)'),
    sa.Column('version', sa.String(length=20), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | in_review | approved | rework'),
    sa.Column('author', sa.String(length=100), nullable=True),
    sa.Column('reviewer', sa.String(length=100), nullable=True),
    sa.Column('approved_by', sa.String(length=100), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['backlog_item_id'], ['backlog_items.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['config_item_id'], ['config_items.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('test_cases',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('requirement_id', sa.Integer(), nullable=True, comment='Linked requirement for traceability'),
    sa.Column('backlog_item_id', sa.Integer(), nullable=True, comment='Linked WRICEF backlog item'),
    sa.Column('config_item_id', sa.Integer(), nullable=True, comment='Linked config item'),
    sa.Column('code', sa.String(length=50), nullable=True, comment='Auto or manual code, e.g. TC-FI-001, TC-SD-042'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('test_layer', sa.String(length=30), nullable=True, comment='unit | sit | uat | regression | performance | cutover_rehearsal'),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module: FI, MM, SD, etc.'),
    sa.Column('preconditions', sa.Text(), nullable=True, comment='Setup / preconditions'),
    sa.Column('test_steps', sa.Text(), nullable=True, comment='Step-by-step test procedure'),
    sa.Column('expected_result', sa.Text(), nullable=True, comment='Expected outcome'),
    sa.Column('test_data_set', sa.Text(), nullable=True, comment='Test data description or reference'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | ready | approved | deprecated'),
    sa.Column('priority', sa.String(length=20), nullable=True, comment='low | medium | high | critical'),
    sa.Column('is_regression', sa.Boolean(), nullable=True, comment='Flagged for regression set (re-run on upgrades/releases)'),
    sa.Column('assigned_to', sa.String(length=100), nullable=True, comment='Tester name'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['backlog_item_id'], ['backlog_items.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['config_item_id'], ['config_items.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('defects',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('program_id', sa.Integer(), nullable=False),
    sa.Column('test_case_id', sa.Integer(), nullable=True, comment='Test case that found this defect'),
    sa.Column('backlog_item_id', sa.Integer(), nullable=True, comment='Linked WRICEF item (fix target)'),
    sa.Column('config_item_id', sa.Integer(), nullable=True, comment='Linked config item (fix target)'),
    sa.Column('code', sa.String(length=50), nullable=True, comment='Auto code, e.g. DEF-0001, DEF-FI-042'),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('steps_to_reproduce', sa.Text(), nullable=True),
    sa.Column('severity', sa.String(length=10), nullable=True, comment='P1 (blocker) | P2 (critical) | P3 (major) | P4 (minor/cosmetic)'),
    sa.Column('status', sa.String(length=30), nullable=True, comment='new | open | in_progress | fixed | retest | closed | rejected | reopened'),
    sa.Column('module', sa.String(length=50), nullable=True, comment='SAP module'),
    sa.Column('environment', sa.String(length=50), nullable=True, comment='DEV | QAS | PRD'),
    sa.Column('reported_by', sa.String(length=100), nullable=True),
    sa.Column('assigned_to', sa.String(length=100), nullable=True),
    sa.Column('found_in_cycle', sa.String(length=100), nullable=True, comment='Which test cycle found it'),
    sa.Column('reported_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('resolved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('reopen_count', sa.Integer(), nullable=True, comment='Number of times reopened'),
    sa.Column('resolution', sa.Text(), nullable=True, comment='Fix description'),
    sa.Column('root_cause', sa.Text(), nullable=True, comment='Root cause analysis'),
    sa.Column('transport_request', sa.String(length=30), nullable=True, comment='SAP transport for the fix'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['backlog_item_id'], ['backlog_items.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['config_item_id'], ['config_items.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['program_id'], ['programs.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['test_case_id'], ['test_cases.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('technical_specs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('functional_spec_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=300), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('content', sa.Text(), nullable=True, comment='Full TS document body (Markdown/HTML)'),
    sa.Column('version', sa.String(length=20), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=True, comment='draft | in_review | approved | rework'),
    sa.Column('author', sa.String(length=100), nullable=True),
    sa.Column('reviewer', sa.String(length=100), nullable=True),
    sa.Column('approved_by', sa.String(length=100), nullable=True),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('objects_list', sa.Text(), nullable=True, comment='List of technical objects (classes, function modules, tables, etc.)'),
    sa.Column('unit_test_evidence', sa.Text(), nullable=True, comment='Unit test results / evidence reference'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['functional_spec_id'], ['functional_specs.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('test_executions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('cycle_id', sa.Integer(), nullable=False),
    sa.Column('test_case_id', sa.Integer(), nullable=False),
    sa.Column('result', sa.String(length=20), nullable=True, comment='not_run | pass | fail | blocked | deferred'),
    sa.Column('executed_by', sa.String(length=100), nullable=True, comment='Tester name'),
    sa.Column('executed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('duration_minutes', sa.Integer(), nullable=True, comment='Execution time in minutes'),
    sa.Column('notes', sa.Text(), nullable=True, comment='Execution notes / evidence'),
    sa.Column('evidence_url', sa.String(length=500), nullable=True, comment='Screenshot / log URL'),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['cycle_id'], ['test_cycles.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['test_case_id'], ['test_cases.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('test_executions')
    op.drop_table('technical_specs')
    op.drop_table('defects')
    op.drop_table('test_cases')
    op.drop_table('functional_specs')
    op.drop_table('requirement_traces')
    op.drop_table('requirement_process_mappings')
    op.drop_table('open_items')
    op.drop_table('config_items')
    op.drop_table('backlog_items')
    op.drop_table('requirements')
    op.drop_table('analyses')
    op.drop_table('workshops')
    op.drop_table('test_cycles')
    op.drop_table('team_members')
    op.drop_table('risks')
    op.drop_table('processes')
    op.drop_table('issues')
    op.drop_table('gates')
    op.drop_table('decisions')
    op.drop_table('actions')
    op.drop_table('workstreams')
    op.drop_table('test_plans')
    op.drop_table('sprints')
    op.drop_table('scenarios')
    op.drop_table('phases')
    op.drop_table('notifications')
    op.drop_table('committees')
    op.drop_table('ai_usage_logs')
    with op.batch_alter_table('ai_suggestions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_ai_suggestions_status'))

    op.drop_table('ai_suggestions')
    with op.batch_alter_table('ai_embeddings', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_ai_embeddings_entity_type'))
        batch_op.drop_index('ix_ai_embedding_entity')

    op.drop_table('ai_embeddings')
    op.drop_table('programs')
    op.drop_table('ai_audit_logs')
    # ### end Alembic commands ###
